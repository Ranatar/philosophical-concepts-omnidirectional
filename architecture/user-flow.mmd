sequenceDiagram
    actor User as Пользователь
    participant UI as Интерфейс
    participant GS as Сервис графов
    participant TS as Сервис тезисов
    participant CS as Сервис Claude
    participant NS as Сервис анализа названий
    participant OS as Сервис определения происхождения
    participant HS as Сервис исторической контекстуализации
    participant PS as Сервис практического применения
    participant DS as Сервис диалогической интерпретации
    participant ES as Сервис эволюции
    participant GDB as Графовая БД
    participant DDB as Документная БД
    participant RDB as Реляционная БД
    
    Note over User,DDB: Уровень 1: Работа с графом концепции
    
    User->>UI: Создание категории "Субъективная реальность"
    UI->>GS: Запрос на создание категории
    GS->>GDB: Сохранение категории
    GDB-->>GS: Подтверждение
    
    User->>UI: Создание категории "Интерсубъективность"
    UI->>GS: Запрос на создание категории
    GS->>GDB: Сохранение категории
    GDB-->>GS: Подтверждение
    
    User->>UI: Создание связи "Диалектическая" между категориями
    UI->>GS: Запрос на создание связи
    GS->>GDB: Сохранение связи
    GDB-->>GS: Подтверждение
    
    User->>UI: Запрос обогащения категории "Субъективная реальность"
    UI->>CS: Запрос на обогащение
    CS->>GDB: Получение данных о категории и концепции
    GDB-->>CS: Данные
    CS->>Claude: Запрос к Claude
    Claude-->>CS: Развернутое описание
    CS->>DDB: Сохранение обогащения
    DDB-->>CS: Подтверждение
    CS-->>UI: Результат обогащения
    UI-->>User: Отображение результата
    
    User->>UI: Запрос валидации графа
    UI->>CS: Запрос на валидацию
    CS->>GDB: Получение полного графа концепции
    GDB-->>CS: Данные графа
    CS->>Claude: Запрос к Claude
    Claude-->>CS: Анализ и рекомендации
    CS-->>UI: Результаты валидации
    UI-->>User: Отображение результатов
    
    User->>UI: Внесение корректив в граф
    UI->>GS: Обновление графа
    GS->>GDB: Сохранение изменений
    GDB-->>GS: Подтверждение
    
    Note over User,DDB: Уровень 2: Работа с тезисами концепции и двунаправленные преобразования
    
    User->>UI: Запрос на генерацию онтологических тезисов
    UI->>TS: Запрос с параметрами
    TS->>GDB: Получение данных графа
    GDB-->>TS: Данные
    TS->>CS: Запрос на генерацию тезисов
    CS->>Claude: Запрос к Claude
    Claude-->>CS: Сгенерированные тезисы
    CS->>DDB: Сохранение тезисов
    DDB-->>CS: Подтверждение
    CS-->>TS: Результат
    TS-->>UI: Тезисы
    UI-->>User: Отображение тезисов
    
    User->>UI: Запрос на обоснование тезиса
    UI->>CS: Запрос на обоснование
    CS->>DDB: Получение тезиса
    DDB-->>CS: Данные тезиса
    CS->>Claude: Запрос к Claude
    Claude-->>CS: Обоснование и контраргументы
    CS->>DDB: Сохранение обоснования
    DDB-->>CS: Подтверждение
    CS-->>UI: Результат обоснования
    UI-->>User: Отображение обоснования
    
    Note over User,DDB: Генерация графа из тезисов с валидацией новых элементов
    
    User->>UI: Запрос на генерацию графа из тезисов
    UI->>GS: Запрос с параметрами
    GS->>DDB: Получение данных тезисов
    DDB-->>GS: Данные тезисов
    GS->>CS: Запрос на генерацию графа
    CS->>Claude: Запрос к Claude
    Claude-->>CS: Сгенерированный граф
    CS-->>GS: Результат
    
    Note over GS,RDB: Валидация новых элементов
    GS->>RDB: Проверка существования категорий
    RDB-->>GS: Результаты проверки
    GS->>RDB: Проверка существования типов связей
    RDB-->>GS: Результаты проверки
    
    alt Обнаружены новые элементы
        GS->>DDB: Сохранение новых элементов в GeneratedElements
        DDB-->>GS: Подтверждение
        GS-->>UI: Граф + requiresApproval: true
        UI-->>User: Отображение графа с предупреждением о новых элементах
        
        Note over User,UI: Процесс одобрения новых элементов
        User->>UI: Просмотр новых элементов
        UI->>GS: Запрос списка новых элементов
        GS->>DDB: Получение новых элементов
        DDB-->>GS: Данные новых элементов
        GS-->>UI: Список новых элементов
        UI-->>User: Отображение компонента одобрения
        
        User->>UI: Редактирование определений (опционально)
        User->>UI: Выбор элементов для одобрения
        User->>UI: Подтверждение одобрения
        UI->>GS: Запрос на одобрение элементов
        
        GS->>RDB: Создание новых шаблонов категорий
        RDB-->>GS: Подтверждение
        GS->>RDB: Создание новых типов связей
        RDB-->>GS: Подтверждение
        GS->>DDB: Обновление статуса в GeneratedElements
        DDB-->>GS: Подтверждение
        
        GS->>GDB: Сохранение графа с новыми элементами
        GDB-->>GS: Подтверждение
        GS-->>UI: Успешное сохранение
        UI-->>User: Отображение финального графа
    else Все элементы существуют
        GS->>GDB: Сохранение графа
        GDB-->>GS: Подтверждение
        GS-->>UI: Результат
        UI-->>User: Отображение сгенерированного графа
    end
    
    Note over User,DDB: Анализ названия концепции
    
    User->>UI: Запрос на анализ названия концепции
    UI->>NS: Запрос на анализ
    NS->>DDB: Получение данных концепции
    DDB-->>NS: Данные
    NS->>CS: Запрос на анализ названия
    CS->>Claude: Запрос к Claude
    Claude-->>CS: Анализ названия и альтернативы
    CS-->>NS: Результат
    NS->>DDB: Сохранение результатов
    DDB-->>NS: Подтверждение
    NS-->>UI: Результаты анализа
    UI-->>User: Отображение результатов
    
    Note over User,DDB: Определение происхождения
    
    User->>UI: Запрос на определение происхождения концепции
    UI->>OS: Запрос на анализ происхождения
    OS->>DDB: Получение тезисов
    DDB-->>OS: Данные тезисов
    OS->>GDB: Получение графа
    GDB-->>OS: Данные графа
    OS->>CS: Запрос на анализ происхождения
    CS->>Claude: Запрос к Claude
    Claude-->>CS: Анализ происхождения и родительские концепции
    CS-->>OS: Результат
    OS->>DDB: Сохранение результатов
    DDB-->>OS: Подтверждение
    OS-->>UI: Результаты анализа
    UI-->>User: Отображение родительских концепций
    
    Note over User,DDB: Историческая контекстуализация
    
    User->>UI: Запрос на историческую контекстуализацию
    UI->>HS: Запрос на контекстуализацию
    HS->>GDB: Получение данных о концепции
    GDB-->>HS: Данные концепции
    HS->>RDB: Получение сведений о философских традициях
    RDB-->>HS: Данные о традициях
    HS->>CS: Запрос на историческую контекстуализацию
    CS->>Claude: Запрос к Claude
    Claude-->>CS: Исторический контекст и анализ
    CS-->>HS: Результат
    HS->>DDB: Сохранение исторического анализа
    DDB-->>HS: Подтверждение
    HS-->>UI: Результаты анализа
    UI-->>User: Отображение исторической контекстуализации
    
    Note over User,DDB: Практическое применение
    
    User->>UI: Запрос на анализ практического применения
    UI->>PS: Запрос на анализ
    PS->>GDB: Получение графа и категорий
    GDB-->>PS: Данные графа
    PS->>DDB: Получение тезисов
    DDB-->>PS: Данные тезисов
    PS->>CS: Запрос на анализ практического применения
    CS->>Claude: Запрос к Claude
    Claude-->>CS: Области и способы применения
    CS-->>PS: Результат
    PS->>DDB: Сохранение результатов
    DDB-->>PS: Подтверждение
    PS-->>UI: Результаты анализа
    UI-->>User: Отображение областей практического применения
    
    Note over User,DDB: Диалогическая интерпретация
    
    User->>UI: Запрос на создание диалога между концепциями
    UI->>DS: Запрос с параметрами (две концепции и философский вопрос)
    DS->>GDB: Получение данных о первой концепции
    GDB-->>DS: Данные первой концепции
    DS->>GDB: Получение данных о второй концепции
    GDB-->>DS: Данные второй концепции
    DS->>DDB: Получение тезисов обеих концепций
    DDB-->>DS: Данные тезисов
    DS->>CS: Запрос на создание диалога
    CS->>Claude: Запрос к Claude
    Claude-->>CS: Философский диалог
    CS-->>DS: Результат
    DS->>DDB: Сохранение диалога
    DDB-->>DS: Подтверждение
    DS-->>UI: Диалог между концепциями
    UI-->>User: Отображение диалога
    
    Note over User,DDB: Эволюция концепции
    
    User->>UI: Запрос на анализ эволюции концепции
    UI->>ES: Запрос на анализ
    ES->>GDB: Получение текущего графа концепции
    GDB-->>ES: Данные графа
    ES->>DDB: Получение тезисов
    DDB-->>ES: Данные тезисов
    ES->>CS: Запрос на анализ эволюции
    CS->>Claude: Запрос к Claude
    Claude-->>CS: Направления эволюции и новые элементы
    CS-->>ES: Результат
    ES->>RDB: Сохранение эволюционного анализа
    RDB-->>ES: Подтверждение
    ES->>DDB: Сохранение новых тезисов
    DDB-->>ES: Подтверждение
    ES-->>UI: Предложения по эволюции концепции
    UI-->>User: Отображение путей эволюции

    Note over User,DDB: Управление ключами API Claude

    User->>UI: Открытие настроек профиля
    UI->>US: Запрос информации о ключе API
    US->>RDB: Получение данных о ключе
    RDB-->>US: Статус ключа
    US-->>UI: Информация о ключе
    UI-->>User: Отображение настроек ключа

    User->>UI: Ввод нового ключа API Claude
    UI->>US: Сохранение ключа API
    US->>US: Валидация и шифрование ключа
    US->>RDB: Сохранение зашифрованного ключа
    RDB-->>US: Подтверждение
    US-->>UI: Успешное сохранение
    UI-->>User: Уведомление об успехе

    Note over User,Claude: Использование с пользовательским ключом

    User->>UI: Запрос на генерацию тезисов
    UI->>TS: Запрос с user_id
    TS->>CS: Запрос на генерацию
    CS->>US: Получить ключ API для user_id
    US->>RDB: SELECT ключ для пользователя
    RDB-->>US: Зашифрованный ключ
    US->>US: Дешифрование
    US-->>CS: Ключ API
    CS->>Claude: Запрос с пользовательским ключом
    Claude-->>CS: Ответ
    CS->>RDB: Сохранить статистику использования
    CS-->>TS: Результат
    TS-->>UI: Тезисы
    UI-->>User: Отображение результата

    Note over User,RDB: Совместное использование ключа

    User->>UI: Открытие настроек совместного доступа
    UI->>US: Запрос на создание общего доступа
    US->>RDB: INSERT INTO shared_api_keys
    RDB-->>US: ID общего доступа
    US-->>UI: Ссылка для совместного доступа
    UI-->>User: Отображение ссылки

    User2->>UI: Принятие общего доступа
    UI->>US: Активация общего доступа
    US->>RDB: UPDATE shared_api_keys
    RDB-->>US: Подтверждение
    US-->>UI: Доступ активирован
    UI-->>User2: Уведомление об успехе